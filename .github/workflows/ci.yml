name: Wren Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.12"

jobs:
  # Detect which components changed to enable conditional execution
  changes:
    runs-on: ubuntu-latest
    outputs:
      wren_src: ${{ steps.changes.outputs.wren_src }}
      wren_agent: ${{ steps.changes.outputs.wren_agent }}
      wren_backend: ${{ steps.changes.outputs.wren_backend }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            wren_src:
              - 'wren_src/**'
              - 'wren_src/pyproject.toml'
            wren_agent:
              - 'wren_agent/**'
              - 'wren_agent/pyproject.toml'
            wren_backend:
              - 'wren_backend/**'
              - 'wren_backend/pyproject.toml'
            shared:
              - '.github/workflows/**'
              - 'CLAUDE.md'
              - 'README.md'

  # Test wren_src (Core SDK)
  test-wren-src:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.wren_src == 'true' || needs.changes.outputs.shared == 'true'

    strategy:
      matrix:
        python-version: ["3.10", "3.13"]  # Test min and max supported versions

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          cd wren_src
          uv sync --extra dev

      - name: Run linting
        run: |
          cd wren_src
          uv run ruff check --fix src tests
          uv run ruff format --check src tests

      - name: Run type checking
        run: |
          cd wren_src
          uv run mypy src/wren

      - name: Run tests with coverage
        run: |
          cd wren_src
          mkdir -p reports
          uv run pytest --verbose --cov=wren --cov-branch --cov-report=xml:reports/coverage.xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./wren_src/reports/coverage.xml
          flags: wren-src
          name: wren-src-${{ matrix.python-version }}
          fail_ci_if_error: false

  # Test wren_agent (AI Agent)
  test-wren-agent:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.wren_agent == 'true' || needs.changes.outputs.shared == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd wren_agent
          uv sync --dev

      - name: Run linting
        run: |
          cd wren_agent
          uv run ruff check --fix agent tests
          uv run ruff format --check agent tests

      - name: Run unit tests with coverage
        run: |
          cd wren_agent
          mkdir -p reports
          uv run pytest tests/unit/ --verbose --cov=agent --cov-branch --cov-report=xml:reports/coverage.xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./wren_agent/reports/coverage.xml
          flags: wren-agent
          name: wren-agent
          fail_ci_if_error: false

      - name: Install semgrep for security testing
        run: |
          cd wren_agent
          uv add semgrep

      - name: Run security tests (static analyzer)
        run: |
          cd wren_agent
          uv run pytest tests/unit/test_static_analyzer.py -v

      # Note: Agent integration tests use a custom runner (not pytest)
      # Run manually with: python -m tests.integration.test_agent

  # Test wren_backend (Platform)
  test-wren-backend:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.wren_backend == 'true' || needs.changes.outputs.shared == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"  # Backend requires Python 3.13+

      - name: Install dependencies
        run: |
          cd wren_backend
          uv sync --dev

      - name: Run unit tests with coverage
        run: |
          cd wren_backend
          mkdir -p reports
          uv run pytest tests/ --verbose --cov=wren_backend --cov-branch --cov-report=xml:reports/coverage.xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./wren_backend/reports/coverage.xml
          flags: wren-backend
          name: wren-backend
          fail_ci_if_error: false

  # Note: Full integration test (agent -> SDK -> backend) disabled as it
  # requires real OpenAI API calls and was not properly configured.
  # TODO: Add proper integration tests with mocks or a test harness.

  # Security and quality checks
  security-and-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install semgrep
        run: pip install semgrep

      - name: Run Semgrep security scan
        run: |
          semgrep --config=auto \
            --exclude="*.md" \
            --exclude="docs/" \
            --exclude="examples/" \
            --severity=ERROR \
            --verbose \
            .

  # Deployment readiness check
  deployment-check:
    runs-on: ubuntu-latest
    needs: [test-wren-src, test-wren-agent, test-wren-backend, security-and-quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Check deployment readiness
        run: |
          echo "âœ… All tests passed"
          echo "âœ… Security checks passed"
          echo "ðŸš€ Ready for deployment"

          # Could add additional checks here:
          # - Version bump validation
          # - Docker image builds
          # - Documentation updates
          # - Release notes generation
