name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [wren_src, wren_agent, wren_backend]

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update dependencies for ${{ matrix.component }}
        run: |
          cd ${{ matrix.component }}

          # Update lockfile with latest compatible versions
          uv sync --upgrade

          # Check if anything changed
          if git diff --quiet pyproject.toml uv.lock; then
            echo "No dependency updates available for ${{ matrix.component }}"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Dependencies updated for ${{ matrix.component }}"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi
        id: update

      - name: Run tests after update
        if: steps.update.outputs.has_updates == 'true'
        run: |
          cd ${{ matrix.component }}

          # Run appropriate tests based on component
          if [ "${{ matrix.component }}" = "wren_src" ]; then
            uv run pytest --verbose
          elif [ "${{ matrix.component }}" = "wren_agent" ]; then
            uv run pytest tests/unit/ --verbose
          elif [ "${{ matrix.component }}" = "wren_backend" ]; then
            uv run pytest tests/ --verbose
          fi

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ matrix.component }}): update dependencies"
          title: "chore(${{ matrix.component }}): update dependencies"
          body: |
            ## Automated Dependency Update for ${{ matrix.component }}

            This PR updates dependencies to their latest compatible versions.

            ### Changes
            - Updated dependencies in `${{ matrix.component }}/pyproject.toml`
            - Updated lockfile `${{ matrix.component }}/uv.lock`

            ### Testing
            - ‚úÖ All tests pass with updated dependencies
            - ‚úÖ No breaking changes detected

            ### Review Notes
            Please review the dependency changes and ensure:
            1. No security vulnerabilities introduced
            2. All functionality remains intact
            3. Performance is not negatively impacted

            Auto-generated by GitHub Actions ü§ñ
          branch: "dependency-update/${{ matrix.component }}"
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ matrix.component }}

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run security audit on all components
        run: |
          echo "üîç Running security audit on all components..."

          for component in wren_src wren_agent wren_backend; do
            echo "Auditing $component..."
            cd $component

            # Install dependencies for audit
            uv sync --dev

            # Run pip-audit if available, otherwise install and run
            if ! uv run pip-audit --version >/dev/null 2>&1; then
              uv add pip-audit
            fi

            # Audit for known vulnerabilities
            uv run pip-audit --desc --format json --output ../audit-$component.json || true

            cd ..
          done

      - name: Process audit results
        run: |
          echo "üìä Processing security audit results..."

          total_vulns=0
          for component in wren_src wren_agent wren_backend; do
            if [ -f "audit-$component.json" ]; then
              vulns=$(jq '.vulnerabilities | length' "audit-$component.json" 2>/dev/null || echo "0")
              echo "$component: $vulns vulnerabilities found"
              total_vulns=$((total_vulns + vulns))
            fi
          done

          echo "Total vulnerabilities across all components: $total_vulns"

          if [ $total_vulns -gt 0 ]; then
            echo "‚ö†Ô∏è Security vulnerabilities detected. Please review audit files."
            exit 1
          else
            echo "‚úÖ No security vulnerabilities detected."
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: audit-*.json
          retention-days: 30